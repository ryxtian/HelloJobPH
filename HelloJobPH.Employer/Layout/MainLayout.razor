@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using HelloJobPH.Employer.JwtAuthStateProviders
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation

@* Required MudBlazor Providers *@
<MudThemeProvider Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <!-- AppBar -->
    <MudAppBar Elevation="2" Dense="false">
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@ToggleDrawer" />

        <MudText Typo="Typo.h6" Class="ml-3">HelloJobPH</MudText>

        <MudSpacer />

        @if (user != null && user.Identity != null && user.Identity.IsAuthenticated)
        {
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">

                <MudDivider Vertical="true" FlexItem="true" />

                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudAvatar Color="Color.Primary" Size="Size.Medium">
                        @GetInitials(fullName)
                    </MudAvatar>
                    <MudStack Spacing="0" Class="mr-2">
                        <MudText Typo="Typo.body2" Class="white-text">
                            <b>@fullName</b>
                        </MudText>
                        @if (!string.IsNullOrEmpty(userRole))
                        {
                            <MudText Typo="Typo.caption" Class="white-text" Style="opacity: 0.8;">
                                @userRole
                            </MudText>
                        }
                    </MudStack>
                </MudStack>

                <MudMenu Icon="@Icons.Material.Filled.ArrowDropDown"
                         Color="Color.Inherit"
                         AnchorOrigin="Origin.BottomRight"
                         TransformOrigin="Origin.TopRight">
                    <MudMenuItem Icon="@Icons.Material.Filled.Person">Profile</MudMenuItem>
                    <MudMenuItem Icon="@Icons.Material.Filled.Settings">Settings</MudMenuItem>
                    <MudDivider />
                    <MudMenuItem Icon="@Icons.Material.Filled.Logout"
                                 IconColor="Color.Error"
                                 OnClick="Logout">
                        Logout
                    </MudMenuItem>
                </MudMenu>
            </MudStack>
        }
    </MudAppBar>

    <!-- Drawer -->
    <MudDrawer @bind-Open="_drawerOpen"
               Elevation="4"
               Class="mud-drawer"
               Anchor="Anchor.Start"
               ClipMode="DrawerClipMode.Always">
        <MudDrawerHeader>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Business"
                         Color="Color.Primary"
                         Size="Size.Large" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.h6" Color="Color.Primary">HelloJobPH</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Employer Portal</MudText>
                </MudStack>
            </MudStack>
        </MudDrawerHeader>

        <MudNavMenu>
            <MudNavLink Href="/dashboard/dashboard" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
            <MudNavLink Href="/jobpost/JobPost" Icon="@Icons.Material.Filled.AddBox">Job Post</MudNavLink>
            <MudNavLink Href="/Candidate/Candidate" Icon="@Icons.Material.Filled.PersonSearch">Candidates</MudNavLink>
            <MudNavLink Href="/Candidate/AcceptedCandidates" Icon="@Icons.Material.Filled.HowToReg">Accepted Candidates</MudNavLink>

            <div class="nav-divider"></div>

            <MudNavLink Href="/interview/initial" Icon="@Icons.Material.Filled.EventNote">Interviews</MudNavLink>
            <MudNavLink Href="/audit/auditlog" Icon="@Icons.Material.Filled.History">Audit Log</MudNavLink>

            @if (isEmployer)
            {
                <div class="nav-divider"></div>
                <MudNavLink Href="/HumanResource/Recruiter" Icon="@Icons.Material.Filled.People">HR Management</MudNavLink>
                <div class="nav-divider"></div>
                <MudNavLink Href="/jobpost/audit" Icon="@Icons.Material.Filled.Description">Job Audit</MudNavLink>
            }
        </MudNavMenu>
    </MudDrawer>

    <!-- Main content -->
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4 mb-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>


@code {
    private ClaimsPrincipal? user;
    private string? fullName;
    private string? userRole;
    private bool _drawerOpen = true;
    private bool isEmployer;

    private MudTheme _theme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#1976d2",
            Secondary = "#424242",
            AppbarBackground = "#1976d2",
            AppbarText = "#ffffff",
            DrawerBackground = "#ffffff",
            DrawerText = "rgba(0,0,0,0.87)"
        }
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var firstName = user.FindFirst(c => c.Type == ClaimTypes.Name)?.Value;
            var lastName = user.FindFirst(c => c.Type == ClaimTypes.Surname)?.Value;
            userRole = user.FindFirst(c => c.Type == ClaimTypes.Role)?.Value;
            fullName = $"{firstName} {lastName}";
            isEmployer = user.IsInRole("Employer");
        }
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private string GetInitials(string? name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return "??";

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2
            ? $"{parts[0][0]}{parts[1][0]}".ToUpper()
            : name.Length >= 2 ? name.Substring(0, 2).ToUpper() : name.ToUpper();
    }

    private async Task Logout()
    {
        if (AuthProvider is JwtAuthStateProvider jwtAuth)
            await jwtAuth.MarkUserAsLoggedOut();

        Navigation.NavigateTo("/", true);
    }
}
