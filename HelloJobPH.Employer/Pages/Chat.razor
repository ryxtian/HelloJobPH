@page "/chat"
@using HelloJobPH.Employer.Services.ChatService
@using HelloJobPH.Shared.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims

@inject ChatService ChatService
@inject AuthenticationStateProvider AuthProvider

<MudPaper Class="pa-4" Elevation="3">
    <MudText Typo="Typo.h5">HQ ⇄ Sys Chat</MudText>

    <MudTextField @bind-Value="message" Label="Message" Variant="Variant.Outlined" />
    <MudButton OnClick="SendMessage" Color="Color.Primary" Variant="Variant.Filled" Class="mt-2">Send</MudButton>

    <MudDivider Class="my-4" />

    <MudList T="string">
        @foreach (var msg in messages)
        {
            <MudListItem>
                <b>@(msg.User == senderId ? "You" : msg.User):</b> @msg.Text
            </MudListItem>
        }
    </MudList>
</MudPaper>

@code {
    private string senderId;
    private string receiverId = "8";
    private string message = "";
    private List<(string User, string Text)> messages = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            senderId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        }

        // Initialize SignalR
        await ChatService.InitializeAsync();

        // Subscribe to incoming messages
        ChatService.OnMessageReceived += (user, msg) =>
        {
            messages.Add((user, msg));
            InvokeAsync(StateHasChanged);
        };

        // Load chat history
        await LoadChatHistory(senderId, receiverId);
    }

    private async Task LoadChatHistory(string senderId, string receiverId)
    {
        try
        {
            var history = await ChatService.ChatHistory(receiverId, senderId);

            if (history != null)
            {
                // Map ChatMessageDtos to your messages list
                messages = history.Select(m => (m.SenderId, m.Message)).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading chat history: {ex.Message}");
        }
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(message) && !string.IsNullOrEmpty(senderId))
        {
            await ChatService.SendMessage(receiverId, message, senderId);

            // Add the message immediately to UI
            messages.Add((senderId, message));
            message = "";
        }
    }
}
