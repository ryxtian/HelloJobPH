@page "/superadmin/employers"
@using HelloJobPH.Employer.Services.ChatService
@using HelloJobPH.Employer.Services.SuperAdmin
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@layout SuperAdminLayout
@inject IDialogService DialogService
@inject IClientSuperAdminService _service
@inject ChatService ChatService

<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px;
    }

    .employer-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        border: 1px solid rgba(0,0,0,0.08);
    }

    .employer-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1) !important;
    }

    .search-bar {
        border-radius: 50px;
    }

    .status-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-active {
        background: rgba(72, 187, 120, 0.15);
        color: #48bb78;
    }

    .status-inactive {
        background: rgba(203, 213, 224, 0.5);
        color: #718096;
    }

    .status-pending {
        background: rgba(237, 137, 54, 0.15);
        color: #ed8936;
    }
</style>

<!-- Page Header -->
<MudPaper Class="page-header pa-6 mb-6" Elevation="0">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudStack Spacing="1">
            <MudText Typo="Typo.h4" Style="font-weight: 700;">
                <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" />
                Employers
            </MudText>
            <MudText Typo="Typo.body1" Style="opacity: 0.9;">
                Manage and monitor all registered employers
            </MudText>
        </MudStack>
    </MudStack>
</MudPaper>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-0">
    <!-- Search and Filters -->
    <MudPaper Elevation="2" Class="pa-4 mb-4" Style="border-radius: 12px;">
        <MudGrid Spacing="3" AlignItems="Center">
             <MudItem xs="12" md="6">
                <MudTextField @bind-Value="searchQuery"
                              Placeholder="Search employers by name, email, or industry..."
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Class="search-bar"
                              Immediate="true"
                              OnKeyUp="FilterEmployers" />
            </MudItem> 
        </MudGrid>
    </MudPaper>

    <!-- Stats Summary -->
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4" Style="border-left: 4px solid #48bb78; border-radius: 8px;">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Total Employers</MudText>
                    <MudText Typo="Typo.h5" Style="font-weight: 700;">@employers.Count</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>

    </MudGrid>

    <!-- Employers Table -->
    <MudPaper Elevation="2" Style="border-radius: 12px;">
        <MudTable Items="@filteredEmployers" 
                  Hover="true" 
                  Breakpoint="Breakpoint.Sm"
                  Loading="@isLoading"
                  LoadingProgressColor="Color.Primary">
            <HeaderContent>
                <MudTh>Company</MudTh>
                <MudTh>Contact Person</MudTh>
                <MudTh>Industry</MudTh>
                <MudTh>Job Posts</MudTh>
                <MudTh>Status</MudTh>
                <MudTh Style="text-align: center;">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Company">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudAvatar Color="Color.Primary" Size="Size.Medium">
                            @context.CompanyName.Substring(0, 1)
                        </MudAvatar>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">@context.CompanyName</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.ContactEmail</MudText>
                        </MudStack>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Contact Person">
                    <MudStack Spacing="0">
                  
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.ContactNumber</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Industry">
                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@context.Industry</MudChip>
                </MudTd>
               <MudTd DataLabel="Job Posts">
                    <MudText Typo="Typo.body2" Style="font-weight: 600;">@context.JobPostsCount</MudText>
                </MudTd>
                 <MudTd DataLabel="Status">
                    <MudChip T="string" Size="Size.Small" 
                             Class="@GetStatusClass(context.Status)">
                        @context.Status
                    </MudChip>
                </MudTd> 
              @*   <MudTd DataLabel="Member Since">
                    <MudText Typo="Typo.body2">@context.JoinedDate.ToString("MMM dd, yyyy")</MudText>
                </MudTd> *@
                <MudTd DataLabel="Actions" Style="text-align: center;">
                    <MudStack Row="true" Spacing="1" Justify="Justify.Center">
                        <MudIconButton Icon="@Icons.Material.Filled.Check" 
                                       Size="Size.Small" 
                                       Color="Color.Tertiary"
                                       Title="Approved"
                                       OnClick="@(() => Approved(context.EmployerId))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Chat"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       Title="Chat"
                                       OnClick="@(() => OpenChat(context.EmployerId, context.CompanyName))" />

                       
                        <MudIconButton Icon="@Icons.Material.Filled.DisabledVisible" 
                                       Size="Size.Small" 
                                       Color="Color.Error"
                                       Title="Disable"
                                       OnClick="@(() => Disable(context.EmployerId))" />

                    </MudStack>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>












<MudContainer>
    @foreach (var chat in openChats)
    {
        <MudPaper Elevation="10" Class="chat-container animate-fade-in" style="@($"right:{chat.OffsetRight}px")">

            <!-- Header -->
            <MudStack Row AlignItems="AlignItems.Center" JustifyContent="SpaceBetween" Class="chat-header">
                <MudText Typo="Typo.subtitle2">@chat.CompanyName</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="@(() => CloseChat(chat))" />
            </MudStack>

            <!-- Messages -->
            <MudContainer Class="chat-body">
                @foreach (var msg in chat.Messages)
                {
                    <div class="message-row @(msg.User == senderId ? "sent" : "received")">
                        <div class="message-bubble @(msg.User == senderId ? "bubble-sent" : "bubble-received")">
                            @msg.Text
                        </div>
                    </div>
                }
            </MudContainer>

            <MudDivider />

            <!-- Input -->
            <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="p-2 bg-white">
                <MudTextField @bind-Value="chat.NewMessage"
                              Placeholder="Type a message..."
                              Variant="Variant.Outlined"
                              Class="flex-grow rounded-full"
                              OnKeyDown="@(e => HandleKeyPress(e, chat))" />
                <MudIconButton Icon="@Icons.Material.Filled.Send"
                               Color="Color.Primary"
                               Size="Size.Medium"
                               OnClick="@(() => SendMessage(chat))" />
            </MudStack>

        </MudPaper>
    }
</MudContainer>

<style>
    /* Chat container */
    .chat-container {
        position: fixed;
        bottom: 10px;
        width: 320px;
        border-radius: 16px;
        margin: 10px;
        background-color: white;
        display: flex;
        flex-direction: column;
        box-shadow: 0px 4px 12px rgba(0,0,0,0.15);
        animation: fadeIn 0.3s ease-in-out;
    }

    /* Header */
    .chat-header {
        background-color: #1976d2;
        color: white;
        padding: 10px;
        font-weight: 600;
        border-radius: 16px 16px 0 0;
    }

    /* Body */
    .chat-body {
        padding: 10px;
        max-height: 350px;
        overflow-y: auto;
        background-color: #f5f5f5;
        display: flex;
        flex-direction: column;
        height: 400px;
    }

    /* Message rows */
    .message-row {
        display: flex;
        margin-bottom: 8px;
    }

        /* Sent (right side) */
        .message-row.sent {
            justify-content: flex-end;
        }

        /* Received (left side) */
        .message-row.received {
            justify-content: flex-start;
        }

    /* Message bubble */
    .message-bubble {
        max-width: 70%;
        padding: 10px 14px;
        border-radius: 18px;
        font-size: 0.9rem;
        line-height: 1.3;
        word-wrap: break-word;
    }

    /* Sender bubble */
    .bubble-sent {
        background-color: #1976d2;
        color: white;
        border-bottom-right-radius: 4px;
    }

    /* Receiver bubble */
    .bubble-received {
        background-color: #e0e0e0;
        color: #000;
        border-bottom-left-radius: 4px;
    }

    /* Input field */
    .mud-text-field {
        border-radius: 20px;
    }

    /* Fade animation */
    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .mud-badge.mud-badge-top.right {
        FONT-WEIGHT: 500;
        FONT-WEIGHT: 500;
        inset: auto auto calc(50% - 4px) calc(60% - 4px) !important
    }
</style>












@code {
    private List<ChatMessageDtos> notifications { get; set; } = new();
    private List<ChatSession> openChats = new();

    private List<EmployerListDtos> employers = new();
    private List<EmployerListDtos> filteredEmployers = new();
    private string searchQuery = "";
    private string statusFilter = "All";
    private string sortOption = "name";
    private bool isLoading = false;


    private int unreadCount => notifications?.Count ?? 0;
    private string receiverId = string.Empty;

    // Current logged-in user's id (sender)
    private string senderId = string.Empty;





    private HubConnection? hubConnection;



    public class ChatSession
    {
        public int EmployerId { get; set; }
        public string CompanyName { get; set; } = string.Empty;
        // store senderId + text; keep types explicit for readability
        public List<(string User, string Text)> Messages { get; set; } = new();
        public string NewMessage { get; set; } = string.Empty;
        public int OffsetRight { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployers();
    }

    private async Task OpenChat(int employerId, string companyName)
    {
        receiverId = employerId.ToString();
        if (string.IsNullOrEmpty(receiverId))
            return;

        // check if already open
        var existing = openChats.FirstOrDefault(c => c.EmployerId == employerId);
        if (existing == null)
        {
            int offset = 20 + (openChats.Count * 340);

            var newChat = new ChatSession
            {
                EmployerId = employerId,      // this is now EmployerId
                CompanyName = companyName,   // display company name in header
                OffsetRight = offset
            };

            openChats.Add(newChat);

            // load history (sender = you, receiver = employer)
            await LoadChatHistory(senderId, receiverId, newChat);
        }

        StateHasChanged();
    }


    private async Task LoadChatHistory(string senderId, string receiverId, ChatSession chat)
    {
        try
        {
            var history = await ChatService.ChatHistory(receiverId, senderId);
            chat.Messages = history?.Select(m => (m.SenderId, m.Message)).ToList() ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading chat history: {ex.Message}");
        }
    }


    private void HandleKeyPress(KeyboardEventArgs e, ChatSession chat)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(chat.NewMessage))
        {
            // fire and forget; method handles clearing
            _ = SendMessage(chat);
        }
    }
    private async Task SendMessage(ChatSession chat)
    {
        if (chat == null || string.IsNullOrWhiteSpace(chat.NewMessage))
            return;

        var targetId = chat.EmployerId.ToString();
        try
        {
            // Ensure ChatService.SendMessage has this signature (remoteId, message, senderId)
            await ChatService.SendMessage(targetId, chat.NewMessage, senderId);

            // append locally and clear input
            chat.Messages.Add((senderId, chat.NewMessage));
            chat.NewMessage = string.Empty;

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SendMessage error: {ex.Message}");
        }
    }

    private void CloseChat(ChatSession chat) => openChats.Remove(chat);

    // Dispose subscriptions
    public async ValueTask DisposeAsync()
    {
        try
        {
            if (ChatService != null)
            {
                ChatService.OnMessageReceived -= OnChatMessageReceived;
            }

            if (hubConnection is not null)
                await hubConnection.DisposeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Dispose error: {ex.Message}");
        }
    }
    private async void OnChatMessageReceived(string fromUserId, string message)
    {
        try
        {
            var chat = openChats.FirstOrDefault(c => c.EmployerId.ToString() == fromUserId);
            if (chat != null)
            {
                chat.Messages.Add((fromUserId, message));
                await InvokeAsync(StateHasChanged);
            }
            else
            {

                notifications.Insert(0, new ChatMessageDtos
                {
                    SenderId = fromUserId,
                    ApplicantName = "Applicant",
                    CompanyName = "Unknown",
                    Message = message,
                    SentAt = DateTime.UtcNow,
                    IsRead = false
                });
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"OnChatMessageReceived error: {ex.Message}");
        }
    }





























    private async Task LoadEmployers()
    {
        isLoading = true;

        employers = await _service.EmployerList();


        filteredEmployers = employers;
        isLoading = false;
    }

    private void FilterEmployers()
    {
        filteredEmployers = employers.Where(e =>
        {
            // Search filter
            bool matchesSearch = string.IsNullOrWhiteSpace(searchQuery) ||
                e.CompanyName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                e.ContactEmail.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                e.Industry.Contains(searchQuery, StringComparison.OrdinalIgnoreCase);

            // Status filter
            bool matchesStatus = statusFilter == "All" || e.Status == statusFilter;

            return matchesSearch && matchesStatus;
        }).ToList();

        // Apply sorting
        filteredEmployers = sortOption switch
        {
            // "name" => filteredEmployers.OrderBy(e => e.CompanyName).ToList(),
            // "date-new" => filteredEmployers.OrderByDescending(e => e.JoinedDate).ToList(),
            // "date-old" => filteredEmployers.OrderBy(e => e.JoinedDate).ToList(),
            // "jobs" => filteredEmployers.OrderByDescending(e => e.JobPostsCount).ToList(),
            _ => filteredEmployers
        };

        StateHasChanged();
    }

    private string GetStatusClass(string status)
    {
        return status switch
        {
            "Active" => "status-badge status-active",
            "Inactive" => "status-badge status-inactive",
            "Pending" => "status-badge status-pending",
            _ => "status-badge"
        };
    }

    private async Task Approved(int id)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Active",
            "Are you sure you want to Active this employer?",
            yesText: "Active",
            cancelText: "Cancel");

        if (result == true)
        {
            bool results = await _service.ApprovedEmployer(id);

            await LoadEmployers();
        }
    }

    private void EditEmployer(int id)
    {
        NavigationManager.NavigateTo($"/admin/employers/{id}/edit");
    }

    // private async Task DeleteEmployer(int id)
    // {
    //     bool? result = await DialogService.ShowMessageBox(
    //         "Confirm Delete",
    //         "Are you sure you want to delete this employer? This action cannot be undone.",
    //         yesText: "Delete",
    //         cancelText: "Cancel");

    //     if (result == true)
    //     {
    //         // Delete employer logic here
    //         employers.RemoveAll(e => e.EmployerId == id);
    //         //FilterEmployers();
    //         Snackbar.Add("Employer deleted successfully", Severity.Success);
    //     }
    // }

    private async Task Disable(int id)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm disable",
            "Are you sure you want to disable this employer? This action cannot be undone.",
            yesText: "disable",
            cancelText: "Cancel");

        if (result == true)
        {
            bool results = await _service.DisableEmployer(id);
            await LoadEmployers();

            //FilterEmployers();
            //Snackbar.Add("Employer deleted successfully", Severity.Success);
        }
    }

    public class EmployerDto
    {
        public int Id { get; set; }
        public string CompanyName { get; set; }
        public string Email { get; set; }
        public string ContactPerson { get; set; }
        public string Phone { get; set; }
        public string Industry { get; set; }
        public int JobPostsCount { get; set; }
        public string Status { get; set; }
        public DateTime JoinedDate { get; set; }
    }
}