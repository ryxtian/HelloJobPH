@page "/superadmin/jobposts"

@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IClientSuperAdminService _service
@inject IDialogService DialogService
@layout SuperAdminLayout

<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
    }

        .page-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

    .job-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        border-left: 4px solid #667eea;
    }

        .job-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1) !important;
        }

        .job-card.blocked {
            border-left-color: #f56565;
            opacity: 0.7;
        }

    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-active {
        background: rgba(72, 187, 120, 0.15);
        color: #48bb78;
    }

    .status-blocked {
        background: rgba(245, 101, 101, 0.15);
        color: #f56565;
    }

    .company-avatar {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.2rem;
    }
</style>

<!-- Page Header -->
<MudPaper Class="page-header pa-6 mb-6" Elevation="0">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="position: relative; z-index: 1;">
        <MudStack Spacing="1">
            <MudText Typo="Typo.h4" Style="font-weight: 700;">
                Applicants Management
            </MudText>
            <MudText Typo="Typo.body1" Style="opacity: 0.9;">
                Monitor and manage all applicants across the platform
            </MudText>
        </MudStack>

    </MudStack>
</MudPaper>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="pa-0">
    <!-- Stats Overview -->
    <MudGrid Spacing="3" Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Total Jobs</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight: 700;">@jobPosts.Count</MudText>
                    </MudStack>
                    <MudIcon Icon="@Icons.Material.Filled.Work" Color="Color.Primary" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Active Jobs</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight: 700; color: #48bb78;">@jobPosts.Count(j => j.IsDeleted == 0)</MudText>
                    </MudStack>
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Blocked Jobs</MudText>
                        <MudText Typo="Typo.h4" Style="font-weight: 700; color: #f56565;">@jobPosts.Count(j => j.IsDeleted == 1)</MudText>
                    </MudStack>
                    <MudIcon Icon="@Icons.Material.Filled.Block" Color="Color.Error" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Filters and Search -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid Spacing="3">
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="searchQuery"
                              Placeholder="Search by title, company, or location..."
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Variant="Variant.Outlined"
                              Immediate="true"
                              OnDebounceIntervalElapsed="FilterJobs"
                              DebounceInterval="300" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Job Posts List -->
    <MudGrid Spacing="3">
        @foreach (var job in filteredJobPosts)
        {
            <MudItem xs="12">
                <MudPaper Elevation="2" Class="@($"job-card pa-4 {(job.IsDeleted == 1 ? "blocked" : "")}")" Style="border-left: 4px solid var(--mud-palette-primary); transition: all 0.3s ease;">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" md="9">
                            <div>
                                <MudText Typo="Typo.h6" Style="font-weight: 600; margin-bottom: 8px;">
                                    @job.Title
                                </MudText>

                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    @if (!string.IsNullOrEmpty(job.Location))
                                    {
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-geo-alt-fill"></i> @job.Location
                                        </span>
                                    }

                                    @if (job.EmploymentType != null)
                                    {
                                        <span class="badge bg-info text-dark">
                                            <i class="bi bi-briefcase-fill"></i> @job.EmploymentType.ToString()
                                        </span>
                                    }

                                    @if (job.JobCategory!=null)
                                    {
                                        <span class="badge bg-primary">
                                    <i class="bi bi-tags-fill"></i> @job.JobCategory.ToString()
                                        </span>
                                    }

                                    @if (job.SalaryFrom.HasValue || job.SalaryTo.HasValue)
                                    {
                                        <span class="badge bg-success">
                                            <i class="bi bi-cash-stack"></i>
                                            @if (job.SalaryFrom.HasValue && job.SalaryTo.HasValue)
                                            {
                                                @($"₱{job.SalaryFrom:N0} - ₱{job.SalaryTo:N0}")
                                            }
                                            else if (job.SalaryFrom.HasValue)
                                            {
                                                @($"From ₱{job.SalaryFrom:N0}")
                                            }
                                            else
                                            {
                                                @($"Up to ₱{job.SalaryTo:N0}")
                                            }
                                        </span>
                                    }
                                </div>


                                <div class="d-flex flex-wrap align-center gap-3">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Style="vertical-align: middle;" />
                                        Posted: @job.PostedDate.ToString("MMM dd, yyyy")
                                    </MudText>
                                    @if (job.ExpiredDate.HasValue)
                                    {
                                        var daysLeft = (job.ExpiredDate.Value - DateTime.UtcNow).Days;
                                        <MudText Typo="Typo.caption" Color="@(daysLeft <= 7 ? Color.Error : Color.Secondary)">
                                            <MudIcon Icon="@Icons.Material.Filled.EventBusy" Size="Size.Small" Style="vertical-align: middle;" />
                                            Expires: @job.ExpiredDate.Value.ToString("MMM dd, yyyy")
                                            @if (daysLeft > 0)
                                            {
                                                <text>(@daysLeft days left)</text>
                                            }
                                        </MudText>
                                    }
                                    @if (job.IsDeleted == 1)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Block" Label="true">
                                            Blocked
                                        </MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle" Label="true">
                                            Active
                                        </MudChip>
                                    }
                                </div>
                            </div>
                        </MudItem>
                        <MudItem xs="12" md="3" Class="d-flex align-center justify-end">
                            <div class="d-flex gap-2">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Visibility"
                                           Size="Size.Small"
                                           OnClick="@(() => ViewJobDetails(job.JobPostingId))">
                                    View
                                </MudButton>
                                @if (job.IsDeleted == 0)
                                {
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Error"
                                               StartIcon="@Icons.Material.Filled.Block"
                                               Size="Size.Small"
                                               OnClick="@(() => BlockJobPost(job.JobPostingId))">
                                        Block
                                    </MudButton>
                                }
                                else
                                {
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Success"
                                               StartIcon="@Icons.Material.Filled.CheckCircle"
                                               Size="Size.Small"
                                               OnClick="@(() => UnblockJobPost(job.JobPostingId))">
                                        Unblock
                                    </MudButton>
                                }
                            </div>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

 

        }

        @if (!filteredJobPosts.Any())
        {
            <MudItem xs="12">
                <MudPaper Elevation="0" Class="pa-8" Style="text-align:center;">
                    <MudIcon Icon="@Icons.Material.Filled.WorkOff" Size="Size.Large" Color="Color.Secondary" Style="font-size:64px;" />
                    <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-4">
                        No job posts found
                    </MudText>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>
</MudContainer>

@code {
    private List<JobPostingListDtos> jobPosts = new();
    private List<JobPostingListDtos> filteredJobPosts = new();
    private string searchQuery = "";
    private string selectedFilter = "All";

    protected override async Task OnInitializedAsync()
    {
        await LoadJobPosts();
    }

    private async Task LoadJobPosts()
    {
        jobPosts = await _service.JobPostList();
        await FilterJobs();
    }

    private Task FilterJobs()
    {
        filteredJobPosts = jobPosts;

        // Search
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            var q = searchQuery.ToLower();
            filteredJobPosts = filteredJobPosts
                .Where(j => (j.Title ?? "").ToLower().Contains(q) ||
                            (j.CompanyName ?? "").ToLower().Contains(q) ||
                            (j.Location ?? "").ToLower().Contains(q))
                .ToList();
        }

        // Filter
        if (selectedFilter == "Active")
            filteredJobPosts = filteredJobPosts.Where(j => j.IsDeleted == 0).ToList();
        else if (selectedFilter == "Blocked")
            filteredJobPosts = filteredJobPosts.Where(j => j.IsDeleted == 1).ToList();

        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task ApplyFilter(string filter)
    {
        selectedFilter = filter;
        await FilterJobs();
    }

    private async Task BlockJobPost(int jobId)
    {
        var job = jobPosts.FirstOrDefault(j => j.JobPostingId == jobId);
        if (job == null) return;

        bool? confirm = await DialogService.ShowMessageBox(
            "Confirm Block",
            $"Are you sure you want to block '{job.Title}'?",
            yesText: "Block",
            cancelText: "Cancel"
        );

        if (confirm != true) return;

        var result = await _service.BlockJob(job.JobPostingId);
        if (result)
        {
            job.IsDeleted = 1;
            Snackbar.Add($"Job '{job.Title}' has been blocked.", Severity.Warning);
            await FilterJobs();
        }
        else
        {
            Snackbar.Add($"Failed to block '{job.Title}'.", Severity.Error);
        }
    }

    private async Task UnblockJobPost(int jobId)
    {
        var job = jobPosts.FirstOrDefault(j => j.JobPostingId == jobId);
        if (job == null) return;

        bool? confirm = await DialogService.ShowMessageBox(
            "Confirm Unblock",
            $"Are you sure you want to unblock '{job.Title}'?",
            yesText: "Yes",
            cancelText: "No"
        );

        if (confirm != true) return;

        var result = await _service.UnBlockJob(job.JobPostingId);
        if (result)
        {
            job.IsDeleted = 0;
            Snackbar.Add($"Job '{job.Title}' has been unblocked.", Severity.Success);
            await FilterJobs();
        }
        else
        {
            Snackbar.Add($"Failed to unblock '{job.Title}'.", Severity.Error);
        }
    }
    private async Task ViewJobDetails(int jobId)
    {
        var parameters = new DialogParameters
        {
            { "JobId", jobId }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = DialogService.Show<JobDetailsDialog>("Job Details", parameters, options);
        var result = await dialog.Result;
    }
}
