@page "/chat/chat"
@using HelloJobPH.Shared.Model
@inject NavigationManager Navigation
@inject IClientInterviewService CandidateService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudPaper Elevation="2" Class="pa-6">
        <MudStack Spacing="4">
            <!-- Header Section -->
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.h5" Color="Color.Primary">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Class="mr-2" />
                        Initial Interviews
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Manage and review scheduled initial interview candidates
                    </MudText>
                </MudStack>
                <MudChip T="string" Icon="@Icons.Material.Filled.People" Color="Color.Info" Variant="Variant.Filled">
                    @initial.Count Candidate@(initial.Count != 1 ? "s" : "")
                </MudChip>
            </MudStack>

            <MudDivider />

            <!-- Table Section -->
            <MudTable Dense="false" Hover="true" Striped="true" Items="@initial" Elevation="0" Class="rounded-lg">
                <HeaderContent>
                    <MudTh><MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Candidate</strong></MudText></MudTh>
                    <MudTh><MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Position</strong></MudText></MudTh>
                    <MudTh><MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Status</strong></MudText></MudTh>
                    <MudTh><MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Actions</strong></MudText></MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd DataLabel="Candidate">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                            <MudAvatar Color="Color.Primary" Size="Size.Small">
                                @context.Firstname?.Substring(0, 1)@context.Lastname?.Substring(0, 1)
                            </MudAvatar>
                            <MudText Typo="Typo.body2"><strong>@context.Firstname @context.Lastname</strong></MudText>
                        </MudStack>
                    </MudTd>

                    <MudTd DataLabel="Position">
                        <MudText Typo="Typo.body2">@context.JobTitle</MudText>
                    </MudTd>

                    <MudTd DataLabel="Status">
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Info">
                            @context.Status
                        </MudChip>
                    </MudTd>

                    <MudTd DataLabel="Actions">
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                            <MudMenuItem Icon="@Icons.Material.Filled.Chat" OnClick="@(() => OpenChat(context))">
                                Chat
                            </MudMenuItem>
                        </MudMenu>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudStack>
    </MudPaper>
</MudContainer>

<!-- Floating Chat Boxes -->
@foreach (var chat in openChats)
{
    <MudPaper Elevation="10" Class="chat-container animate-fade-in" style="@($"right:{chat.OffsetRight}px")">
        <!-- Header -->
        <MudStack Row AlignItems="AlignItems.Center" JustifyContent="SpaceBetween" Class="chat-header">
            <MudText Typo="Typo.subtitle2">@chat.CandidateName</MudText>
            <MudStack Row Spacing="1">
                <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" Color="Color.Default" OnClick="@(() => CloseChat(chat))" />
            </MudStack>
        </MudStack>

        <!-- Messages -->
        <MudContainer Class="chat-body">
            @foreach (var msg in chat.Messages)
            {
                <div class="@($"chat-message {(msg.IsUser ? "sent" : "received")}")">
                    <MudPaper Class="chat-bubble" Elevation="0">
                        <MudText Typo="Typo.body2">@msg.Content</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@msg.Time.ToShortTimeString()</MudText>
                    </MudPaper>
                </div>
            }
        </MudContainer>

        <!-- Input -->
        <MudDivider />
        <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="p-2">
            <MudTextField @bind-Value="chat.NewMessage"
                          Placeholder="Type a message..."
                          Variant="Variant.Outlined"
                          Class="flex-grow"
                          OnKeyDown="@(e => HandleKeyPress(e, chat))" />
            <MudIconButton Icon="@Icons.Material.Filled.Send"
                           Color="Color.Primary"
                           Disabled="@string.IsNullOrWhiteSpace(chat.NewMessage)"
                           OnClick="@(() => SendMessage(chat))" />
        </MudStack>
    </MudPaper>
}

<style>
    .chat-container {
        position: fixed;
        bottom: 1rem;
        width: 320px;
        height: 400px;
        display: flex;
        flex-direction: column;
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        overflow: hidden;
        z-index: 200;
        margin-right: 1rem;
    }

    .chat-header {
        background-color: #f9fafb;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .chat-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0.75rem;
    }

    .chat-message {
        display: flex;
        margin-bottom: 0.5rem;
    }

        .chat-message.sent {
            justify-content: flex-end;
        }

        .chat-message.received {
            justify-content: flex-start;
        }

    .chat-bubble {
        background-color: #f3f4f6;
        border-radius: 12px;
        padding: 0.5rem 0.75rem;
        max-width: 75%;
    }

    .chat-message.sent .chat-bubble {
        background-color: #e3f2fd;
    }

    .animate-fade-in {
        animation: fadeIn 0.25s ease-in-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

@code {
    private List<InterviewListDtos> initial = new();

    private List<ChatSession> openChats = new();

    protected override async Task OnInitializedAsync()
    {
        initial = await CandidateService.InitialList();
    }

    private void OpenChat(InterviewListDtos candidate)
    {
        // If chat already open, bring it forward
        if (openChats.Any(c => c.CandidateId == candidate.ApplicationId))
            return;

        var offset = 20 + (openChats.Count * 340); // space chats side by side
        openChats.Add(new ChatSession
        {
            CandidateId = candidate.ApplicationId,
            CandidateName = $"{candidate.Firstname} {candidate.Lastname}",
            OffsetRight = offset,
            Messages = new()
            {
                new ChatMessage { Content = $"Hi {candidate.Firstname}, how are you today?", IsUser = false, Time = DateTime.Now }
            }
        });
    }

    private void CloseChat(ChatSession chat) => openChats.Remove(chat);

    private void SendMessage(ChatSession chat)
    {
        if (string.IsNullOrWhiteSpace(chat.NewMessage)) return;

        chat.Messages.Add(new ChatMessage
        {
            Content = chat.NewMessage,
            IsUser = true,
            Time = DateTime.Now
        });

        // You can simulate bot reply or integrate SignalR here
        chat.Messages.Add(new ChatMessage
        {
            Content = "Thanks for your message! We'll get back to you shortly.",
            IsUser = false,
            Time = DateTime.Now.AddSeconds(1)
        });

        chat.NewMessage = string.Empty;
    }

    private void HandleKeyPress(KeyboardEventArgs e, ChatSession chat)
    {
        if (e.Key == "Enter") SendMessage(chat);
    }

    public class ChatSession
    {
        public int CandidateId { get; set; }
        public string CandidateName { get; set; } = string.Empty;
        public List<ChatMessage> Messages { get; set; } = new();
        public string NewMessage { get; set; } = string.Empty;
        public int OffsetRight { get; set; } // controls positioning
    }

    public class ChatMessage
    {
        public string Content { get; set; } = string.Empty;
        public bool IsUser { get; set; }
        public DateTime Time { get; set; }
    }
}
