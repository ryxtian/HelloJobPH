@page "/Interview/initial"
@using HelloJobPH.Employer.Services.Chat
@using Microsoft.AspNetCore.SignalR.Client
@inject IClientChatService ChatService
@inject NavigationManager Navigation
@inject IClientInterviewService CandidateService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject NavigationManager NavigationManger




<style>
    .chat-container {
        position: fixed;
        bottom: 1rem;
        width: 320px;
        height: 400px;
        display: flex;
        flex-direction: column;
        background-color: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        overflow: hidden;
        z-index: 200;
        margin-right: 1rem;
    }

    .chat-header {
        background-color: #f9fafb;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .chat-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0.75rem;
    }

    .chat-message {
        display: flex;
        margin-bottom: 0.5rem;
    }

        .chat-message.sent {
            justify-content: flex-end;
        }

        .chat-message.received {
            justify-content: flex-start;
        }

    .chat-bubble {
        background-color: #f3f4f6;
        border-radius: 12px;
        padding: 0.5rem 0.75rem;
        max-width: 75%;
    }

    .chat-message.sent .chat-bubble {
        background-color: #e3f2fd;
    }

    .animate-fade-in {
        animation: fadeIn 0.25s ease-in-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudPaper Elevation="2" Class="pa-6">
        <MudStack Spacing="4">
            <!-- Header Section -->
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.h5" Color="Color.Primary">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Class="mr-2" />
                        Initial Interviews
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Manage and review scheduled initial interview candidates
                    </MudText>
                </MudStack>

                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">

                    <!-- Candidate count chip -->
                    <MudChip T="string" Icon="@Icons.Material.Filled.People" Color="Color.Info" Variant="Variant.Filled">
                        @initial.Count Candidate@(initial.Count != 1 ? "s" : "")
                    </MudChip>
                </MudStack>
            </MudStack>

            <MudDivider />

            <!-- Table Section -->
            <MudTable Dense="false" 
                      Hover="true" 
                      Bordered="false" 
                      Striped="true"
                      Breakpoint="Breakpoint.Sm" 
                      Items="@initial"
                      Elevation="0"
                      Class="rounded-lg">
                <HeaderContent>
                    <MudTh><MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Candidate</strong></MudText></MudTh>
                    <MudTh><MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Position</strong></MudText></MudTh>
                    <MudTh><MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Status</strong></MudText></MudTh>
                    <MudTh><MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Resume</strong></MudText></MudTh>
                    <MudTh><MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Interview Date</strong></MudText></MudTh>
                    <MudTh><MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Time</strong></MudText></MudTh>
                    <MudTh><MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Type</strong></MudText></MudTh>
                    <MudTh><MudText Typo="Typo.subtitle2" Color="Color.Primary"><strong>Actions</strong></MudText></MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Candidate">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudAvatar Color="Color.Primary" Size="Size.Small">
                                @context.Firstname?.Substring(0, 1)@context.Lastname?.Substring(0, 1)
                            </MudAvatar>
                            <MudText Typo="Typo.body2">
                                <strong>@context.Firstname @context.Lastname</strong>
                            </MudText>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Position">
                        <MudText Typo="Typo.body2">@context.JobTitle</MudText>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Info">
                            @(context.MarkAsCompleted == 1 ? "Completed" : context.Status)
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Resume">
                        <MudButton Href=""
                                   Target="_blank" 
                                   StartIcon="@Icons.Material.Filled.Description" 
                                   Size="Size.Small" 
                                   Variant="Variant.Text" 
                                   Color="Color.Primary">
                            View
                        </MudButton>
                    </MudTd>
                    <MudTd DataLabel="Interview Date">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2">@context.DateInterview?.ToString("dd MMM yyyy")</MudText>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Time">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2">@context.TimeInterview</MudText>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Type">
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@context.Type</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" 
                                 Size="Size.Small" 
                                 Dense="true"
                                 AnchorOrigin="Origin.BottomLeft">
                            <MudMenuItem Icon="@Icons.Material.Filled.Schedule" OnClick="@(() => Reschedule(context))">Reschedule</MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.PersonOff" OnClick="@(() => NoAppearance(context.ApplicationId))">No Appearance</MudMenuItem>
                            <MudDivider />
                            <MudMenuItem Icon="@Icons.Material.Filled.Build" OnClick="@(() => ForTechnical(context))">Technical</MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.EmojiEvents" OnClick="@(() => ForFinal(context))">Final</MudMenuItem>

                            <MudMenuItem Icon="@Icons.Material.Filled.Cancel" OnClick="@(() => Failed(context.ApplicationId))" Class="mud-error-text">Failed</MudMenuItem>
                            <MudDivider />
                            <MudMenuItem OnClick="@(() => Delete(context.ApplicationId))" Icon="@Icons.Material.Filled.Delete" Class="mud-error-text">Delete</MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Visibility" 
                                        OnClick="@(()=> NavigateToOverview(context.ApplicationId))">
                                Overview
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.ChatBubble"
                                        OnClick="@(() => OpenChat(context))">
                                Chat
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.MarkChatRead"
                                         OnClick="@(() => MarkAsCompleted(context.ApplicationId))">
                                Mark As Completed
                            </MudMenuItem>
                        </MudMenu>
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="pa-8">
                        <MudIcon Icon="@Icons.Material.Filled.EventBusy" Size="Size.Large" Color="Color.Secondary" />
                        <MudText Typo="Typo.h6" Color="Color.Secondary">No Scheduled Interviews</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            There are no candidates scheduled for initial interviews at this time.
                        </MudText>
                    </MudStack>
                </NoRecordsContent>
            </MudTable>
        </MudStack>
    </MudPaper>
</MudContainer>







@foreach (var chat in openChats)
{
    <MudPaper Elevation="10" Class="chat-container animate-fade-in" style="@($"right:{chat.OffsetRight}px")">
        <!-- Header -->
        <MudStack Row AlignItems="AlignItems.Center" JustifyContent="SpaceBetween" Class="chat-header">
            <MudText Typo="Typo.subtitle2">@chat.CandidateName</MudText>
            <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="@(() => CloseChat(chat))" />
        </MudStack>

        <!-- Messages -->
        <MudContainer Class="chat-body">
            @foreach (var msg in chat.Messages)
            {
                <MudStack Class="@(msg.SenderId == currentUserId ? "sent-message" : "received-message")" Style="margin-bottom:4px;">
                    <MudText Typo="Typo.body2">@msg.Message</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @msg.SentAt.ToLocalTime().ToShortTimeString()
                    </MudText>
                </MudStack>
            }
        </MudContainer>

        <MudDivider />

        <!-- Input -->
        <MudStack Row AlignItems="AlignItems.Center" Spacing="1" Class="p-2">
            <MudTextField @bind-Value="chat.NewMessage"
                          Placeholder="Type a message..."
                          Variant="Variant.Outlined"
                          Class="flex-grow"
                          OnKeyDown="@(e => HandleKeyPress(e, chat))" />
            <MudIconButton Icon="@Icons.Material.Filled.Send"
                           Color="Color.Primary"
                           Disabled="@string.IsNullOrWhiteSpace(chat.NewMessage)"
                           OnClick="@(() => SendMessage(chat))" />
        </MudStack>
    </MudPaper>
}

@if (!IsConnected)
{
    <span>Connecting...</span>
}

@code {


    private HubConnection hubConnection;
    private List<ChatSession> openChats = new();
    private List<InterviewListDtos> initial = new();
    private string currentUserId = "Employer123"; // ⚡ Replace with actual user ID

    public class ChatSession
    {
        public int CandidateId { get; set; }
        public string CandidateName { get; set; } = string.Empty;
        public List<ChatMessageDtos> Messages { get; set; } = new();
        public string NewMessage { get; set; } = string.Empty;
        public int OffsetRight { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        initial = await CandidateService.InitialList();

        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManger.ToAbsoluteUri("/chathub"))
            .Build();

        // Receive message from SignalR
        hubConnection.On<ChatMessageDtos>("ReceiveMessage", (message) =>
        {
            var chat = openChats.FirstOrDefault(c =>
                c.CandidateId.ToString() == message.SenderId ||
                c.CandidateId.ToString() == message.ReceiverId);

            if (chat == null)
            {
                // Optional: auto-open chat window if it doesn’t exist yet
                chat = new ChatSession
                {
                    CandidateId = int.Parse(message.SenderId),
                    CandidateName = "New Candidate",
                    OffsetRight = openChats.Count * 320
                };
                openChats.Add(chat);
            }

            chat.Messages.Add(message);
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }

    private bool IsConnected => hubConnection?.State == HubConnectionState.Connected;

    private void HandleKeyPress(KeyboardEventArgs e, ChatSession chat)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(chat.NewMessage))
        {
            _ = SendMessage(chat);
        }
    }

    private void CloseChat(ChatSession chat) => openChats.Remove(chat);

    private async Task SendMessage(ChatSession chat)
    {
        if (hubConnection == null || string.IsNullOrWhiteSpace(chat.NewMessage))
            return;

        var chatDto = new ChatMessageDtos
        {
            SenderId = currentUserId,
            ReceiverId = chat.CandidateId.ToString(),
            Message = chat.NewMessage,
            SentAt = DateTime.UtcNow,
            IsRead = false
        };

        // Add immediately to UI
        chat.Messages.Add(chatDto);
        chat.NewMessage = string.Empty;

        // Send via SignalR
        await hubConnection.SendAsync("SendMessage", chatDto);

        // Persist to database
        await ChatService.ChatMessage(chatDto);

        await InvokeAsync(StateHasChanged);
    }

    private void OpenChat(InterviewListDtos candidate)
    {
        if (openChats.Any(c => c.CandidateId == candidate.ApplicationId))
            return;

        var offset = 20 + (openChats.Count * 340);
        openChats.Add(new ChatSession
        {
            CandidateId = candidate.ApplicationId,
            CandidateName = $"{candidate.Firstname} {candidate.Lastname}",
            OffsetRight = offset
        });
    }

    private void NavigateToOverview(int applicationId)
    {
        Navigation.NavigateTo($"/reviewapplicant/reviewapplicant/{applicationId}");
    }

    private async Task Reschedule(InterviewListDtos candidate)
    {
        var parameters = new DialogParameters
        {
            { "Candidate", candidate }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        await DialogService.ShowAsync<RescheduleDialog>("Send Interview Invitation", parameters, options);


    }

    private async Task ForTechnical(InterviewListDtos candidate)
    {
        var parameters = new DialogParameters
        {
            { "Candidate", candidate }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        await DialogService.ShowAsync<ForTechnicalDialog>("Send Interview Invitation", parameters, options);


    }
    private async Task ForFinal(InterviewListDtos candidate)
    {
        var parameters = new DialogParameters
        {
            { "Candidate", candidate }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        await DialogService.ShowAsync<ForFinalDialog>("Send Interview Invitation", parameters, options);


    }
    private async Task NoAppearance(int id)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Action",
            "Are you sure you want to mark this candidate as 'No Appearance'?",
            cancelText: "Cancel",
            yesText: "Yes"
          
        );

        if (result == true)
        {
            var response = await CandidateService.NoAppearance(id);

            if (response > 0)
            {
                Snackbar.Add("Candidate marked as 'No Appearance'.", Severity.Success);
                await JS.InvokeVoidAsync("location.reload");
            }
            else
            {
                Snackbar.Add("Failed to update candidate status.", Severity.Error);
            }
        }
    }
    private async Task Failed(int id)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Action",
            "Are you sure you want to mark this candidate as 'Failed'?",
            cancelText: "Cancel",
            yesText: "Yes"

        );

        if (result == true)
        {
            var response = await CandidateService.Failed(id);

            if (response > 0)
            {
                Snackbar.Add("Candidate marked as 'Failed'.", Severity.Success);
                await JS.InvokeVoidAsync("location.reload");
            }
            else
            {
                Snackbar.Add("Failed to update candidate status.", Severity.Error);
            }
        }
    }
    private async Task Delete(int id)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Action",
            "Are you sure you want to mark this candidate as 'Failed'?",
            cancelText: "Cancel",
            yesText: "Yes"

        );

        if (result == true)
        {
            var response = await CandidateService.Delete(id);

            if (response > 0)
            {
                Snackbar.Add("Candidate marked as 'Delete'.", Severity.Success);
                await JS.InvokeVoidAsync("location.reload");
            }
            else
            {
                Snackbar.Add("Failed to update candidate status.", Severity.Error);
            }
        }
    }

    private async Task MarkAsCompleted(int id)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm",
            "Are you sure you want to mark this candidate as 'Complete?'?",
            cancelText: "Cancel",
            yesText: "Yes"

        );

        if (result == true)
        {
            var response = await CandidateService.MarkAsCompleted(id);

            if (response > 0)
            {
                Snackbar.Add("Candidate marked as 'Complete'.", Severity.Success);
                await JS.InvokeVoidAsync("location.reload");
                
            }
            else
            {
                Snackbar.Add("Failed to update candidate status.", Severity.Error);
            }
        }
    }

}