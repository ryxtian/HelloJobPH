@using MudBlazor
@using MudBlazor.Components
@inject ISnackbar Snackbar
@inject IClientCandidateService Service
@inject IClientInterviewService Interview
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IJSRuntime JS

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" Model="@_emailModel">

            <!-- Interview Date -->
            <MudDatePicker Label="Interview Date"
                           @bind-Date="_emailModel.InterviewDate"
                           Required="true"
                           RequiredError="Interview date is required"
                           Class="mb-2"
                           PickerVariant="PickerVariant.Dialog" />

            <!-- Interview Time -->
            <MudTimePicker Label="Interview Time"
                           @bind-Time="_emailModel.InterviewTime"
                           Required="true"
                           RequiredError="Interview time is required"
                           Class="mb-2"
                           PickerVariant="PickerVariant.Dialog" />

            <!-- Mode -->
            <MudSelect @bind-Value="_emailModel.Mode"
                       Label="Select Interview Mode"
                       Variant="Variant.Outlined"
                       Required="true"
                       Clearable
                       Class="mb-2">
                @foreach (var state in _modes)
                {
                    <MudSelectItem Value="@state">@state</MudSelectItem>
                }
            </MudSelect>

            <!-- Assign To -->
            <MudTextField Label="Assign To"
                          @bind-Value="_emailModel.AssignTo"
                          Required="true"
                          Variant="Variant.Outlined"
                          Class="mb-2" />

            <!-- Location -->
            <MudTextField Label="Location"
                          @bind-Value="_emailModel.Location"
                          Lines="3"
                          Variant="Variant.Outlined"
                          Required="true"
                          Class="mb-3" />

            <!-- Buttons -->
            <MudStack Row="true" Spacing="2">
                <MudButton Color="Color.Primary"
                           Variant="Variant.Filled"
                           OnClick="Reschedule">
                    Reschedule
                </MudButton>
                <MudButton Color="Color.Secondary"
                           Variant="Variant.Text"
                           OnClick="Cancel">
                    Cancel
                </MudButton>
            </MudStack>
        </MudForm>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public InterviewListDtos Candidate { get; set; } = default!;

    private MudForm _form = default!;
    private EmailModel _emailModel = new();

    private readonly string[] _modes =
    [
        "Onsite Interview",
        "Online Interview"
    ];

    protected override void OnInitialized()
    {
        _emailModel.InterviewDate = DateTime.Now.AddDays(1);
        _emailModel.InterviewTime = TimeSpan.FromHours(9);
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Reschedule()
    {
        await _form.Validate();
        if (!_form.IsValid)
        {
            Snackbar.Add("Please fill all required fields.", Severity.Error);
            return;
        }

        bool? confirm = await DialogService.ShowMessageBox(
            "Confirm Reschedule",
            "Are you sure you want to reschedule this interview?",
            yesText: "Confirm",
            cancelText: "Cancel");

        if (confirm != true)
            return;

        var dto = new SetScheduleDto
        {
            ApplicationId = Candidate.ApplicationId,
            Date = _emailModel.InterviewDate!.Value.ToString("yyyy-MM-dd"),
            Time = _emailModel.InterviewTime!.Value.ToString(@"hh\:mm"),
            Location = _emailModel.Location,
            Mode = _emailModel.Mode,
            InterviewBy = _emailModel.AssignTo ?? string.Empty
        };

        bool success = await Interview.Reschedule(dto);

        if (success)
        {
            Snackbar.Add("Interview rescheduled and email sent successfully.", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
            await JS.InvokeVoidAsync("location.reload");
        }
        else
        {
            Snackbar.Add("Failed to reschedule. Candidate not found.", Severity.Error);
        }
    }

    private class EmailModel
    {
        public DateTime? InterviewDate { get; set; }
        public TimeSpan? InterviewTime { get; set; }
        public string? AssignTo { get; set; }
        public string? Location { get; set; }
        public string? Mode { get; set; }
    }
}
