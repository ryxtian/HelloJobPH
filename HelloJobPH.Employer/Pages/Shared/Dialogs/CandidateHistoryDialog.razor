@using HelloJobPH.Employer.Services.AuditLog
@using HelloJobPH.Shared.DTOs
@inject IClientAuditLogService AuditLogService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-height: 70vh; overflow-y: auto;">
            @if (isLoading)
            {
                <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="pa-8">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                    <MudText Typo="Typo.body1">Loading history...</MudText>
                </MudStack>
            }
            else if (interviewHistories != null && interviewHistories.Any())
            {
                <MudStack Spacing="4">
                    <!-- Applicant Information -->
                    <MudCard Elevation="3">
                        <MudCardContent>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                                    <MudAvatar Color="Color.Primary" Size="Size.Large">
                                        @GetInitials(interviewHistories.First().CandidateName)
                                    </MudAvatar>
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.h6">
                                            @interviewHistories.First().CandidateName
                                        </MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            Application ID: #@ApplicationId
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                                <MudChip T="string"
                                         Color="@GetStatusColor(interviewHistories.First().Status)"
                                         Size="Size.Large"
                                         Variant="Variant.Filled">
                                    @interviewHistories.First().Status
                                </MudChip>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>

                    <!-- Interview History Timeline -->
                    <MudCard Elevation="2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" />
                                    Interview History
                                </MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start">
                                @foreach (var history in interviewHistories.OrderByDescending(h => h.CreatedAt))
                                {
                                    <MudTimelineItem Color="@GetTimelineColor(history.Status)" Size="Size.Small">
                                        <ItemOpposite>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                @history.CreatedAt.ToString("dd MMM yyyy")
                                            </MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @history.CreatedAt.ToString("hh:mm tt")
                                            </MudText>
                                        </ItemOpposite>
                                        <ItemContent>
                                            <MudCard Elevation="1" Class="mb-2">
                                                <MudCardContent>
                                                    <MudStack Spacing="2">
                                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                                                            <MudChip T="string"
                                                                     Size="Size.Small"
                                                                     Color="@GetTimelineColor(history.Status)"
                                                                     Variant="Variant.Filled">
                                                                @history.Status
                                                            </MudChip>
                                                            @if (!string.IsNullOrEmpty(history.InterviewBy))
                                                            {
                                                                <MudChip T="string"
                                                                         Size="Size.Small"
                                                                         Icon="@Icons.Material.Filled.Person"
                                                                         Variant="Variant.Text">
                                                                    @history.InterviewBy
                                                                </MudChip>
                                                            }
                                                        </MudStack>

                                                        <MudText Typo="Typo.body2" Color="Color.Primary">
                                                            <MudIcon Icon="@Icons.Material.Filled.Label" Size="Size.Small" Class="mr-1" />
                                                            <strong>Stage:</strong> @history.Stage
                                                        </MudText>

                                                        @if (history.ScheduledDate.HasValue)
                                                        {
                                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                                <MudIcon Icon="@Icons.Material.Filled.Event" Size="Size.Small" Class="mr-1" />
                                                                <strong>Scheduled:</strong> @history.ScheduledDate.Value.ToString("dd MMM yyyy")
                                                            </MudText>
                                                        }
                                                    </MudStack>
                                                </MudCardContent>
                                            </MudCard>
                                        </ItemContent>
                                    </MudTimelineItem>
                                }
                            </MudTimeline>
                        </MudCardContent>
                    </MudCard>
                </MudStack>
            }
            else
            {
                <MudAlert Severity="Severity.Info">No interview history found for this application.</MudAlert>
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Variant="Variant.Filled" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public int ApplicationId { get; set; }

    private List<InterviewHistoryDtos>? interviewHistories;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadInterviewHistory();
    }

    private async Task LoadInterviewHistory()
    {
        isLoading = true;
        try
        {
            interviewHistories = await AuditLogService.GetInterviewHistory(ApplicationId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading history: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetInitials(string fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName))
            return "NA";

        var parts = fullName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[parts.Length - 1][0]}".ToUpper();

        return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();
    }

    private Color GetStatusColor(string status)
    {
        return status?.ToLower() switch
        {
            "completed" or "passed" or "approved" => Color.Success,
            "cancelled" or "rejected" or "failed" => Color.Error,
            "scheduled" or "in progress" => Color.Info,
            "pending" or "awaiting" => Color.Warning,
            _ => Color.Default
        };
    }

    private Color GetTimelineColor(string status)
    {
        return status?.ToLower() switch
        {
            var s when s.Contains("complet") || s.Contains("pass") || s.Contains("approv") => Color.Success,
            var s when s.Contains("schedul") || s.Contains("progress") => Color.Primary,
            var s when s.Contains("reject") || s.Contains("fail") || s.Contains("cancel") => Color.Error,
            var s when s.Contains("pend") || s.Contains("await") => Color.Warning,
            _ => Color.Info
        };
    }

    private void Close()
    {
        MudDialog.Close(DialogResult.Ok(true));
    }
}