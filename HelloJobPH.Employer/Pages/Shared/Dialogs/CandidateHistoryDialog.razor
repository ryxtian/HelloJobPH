@inject IClientCandidateService CandidateService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-height: 70vh; overflow-y: auto;">
            @if (isLoading)
            {
                <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="pa-8">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                    <MudText Typo="Typo.body1">Loading history...</MudText>
                </MudStack>
            }
            else if (candidateHistory != null)
            {
                <MudStack Spacing="4">
                    <!-- Applicant Information -->
                    <MudCard Elevation="3">
                        <MudCardContent>
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                                    <MudAvatar Color="Color.Primary" Size="Size.Large">
                                        @candidateHistory.FirstName?.Substring(0, 1)@candidateHistory.LastName?.Substring(0, 1)
                                    </MudAvatar>
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.h6">
                                            @candidateHistory.FirstName @candidateHistory.LastName
                                        </MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            Application ID: #@candidateHistory.ApplicationId
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                                <MudChip T="string"
                                         Color="@GetStatusColor(candidateHistory.CurrentStatus)"
                                         Size="Size.Large"
                                         Variant="Variant.Filled">
                                    @candidateHistory.CurrentStatus
                                </MudChip>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>

                    <!-- Application History Timeline -->
                    <MudCard Elevation="2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" />
                                    Application History
                                </MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            @if (candidateHistory.Timeline != null && candidateHistory.Timeline.Any())
                            {
                                <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start">
                                    @foreach (var item in candidateHistory.Timeline.OrderByDescending(t => t.Timestamp))
                                    {
                                        <MudTimelineItem Color="@GetTimelineColor(item.Status)" Size="Size.Small">
                                            <ItemOpposite>
                                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                    @item.Timestamp.ToString("dd MMM yyyy")
                                                </MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @item.Timestamp.ToString("hh:mm tt")
                                                </MudText>
                                            </ItemOpposite>
                                            <ItemContent>
                                                <MudCard Elevation="1" Class="mb-2">
                                                    <MudCardContent>
                                                        <MudStack Spacing="2">
                                                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                                                <MudChip T="string"
                                                                         Size="Size.Small"
                                                                         Color="@GetTimelineColor(item.Status)"
                                                                         Variant="Variant.Filled">
                                                                    @item.Status
                                                                </MudChip>
                                                                @if (!string.IsNullOrEmpty(item.HRAssist))
                                                                {
                                                                    <MudChip T="string"
                                                                             Size="Size.Small"
                                                                             Icon="@Icons.Material.Filled.Person"
                                                                             Variant="Variant.Text">
                                                                        @item.HRAssist
                                                                    </MudChip>
                                                                }
                                                            </MudStack>
                                                            @if (!string.IsNullOrEmpty(item.Remarks))
                                                            {
                                                                <MudText Typo="Typo.body2">@item.Remarks</MudText>
                                                            }
                                                        </MudStack>
                                                    </MudCardContent>
                                                </MudCard>
                                            </ItemContent>
                                        </MudTimelineItem>
                                    }
                                </MudTimeline>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info">No history records found.</MudAlert>
                            }
                        </MudCardContent>
                    </MudCard>
                </MudStack>
            }
            else
            {
                <MudAlert Severity="Severity.Warning">Unable to load application history.</MudAlert>
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Variant="Variant.Filled" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public int ApplicationId { get; set; }

    private CandidateHistoryDto? candidateHistory;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCandidateHistory();
    }

    private async Task LoadCandidateHistory()
    {
        isLoading = true;
        try
        {
            // candidateHistory = await CandidateService.GetCandidateHistory(ApplicationId);

            // Mock data for demonstration
            await Task.Delay(1000);
            candidateHistory = GetMockData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading history: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private Color GetStatusColor(string status)
    {
        return status?.ToLower() switch
        {
            "hired" or "accepted" => Color.Success,
            "rejected" or "declined" => Color.Error,
            "in progress" or "interviewing" => Color.Info,
            "pending" or "under review" => Color.Warning,
            _ => Color.Default
        };
    }

    private Color GetTimelineColor(string status)
    {
        return status?.ToLower() switch
        {
            var s when s.Contains("submit") || s.Contains("applied") => Color.Info,
            var s when s.Contains("interview") || s.Contains("schedule") => Color.Primary,
            var s when s.Contains("accept") || s.Contains("hire") || s.Contains("pass") => Color.Success,
            var s when s.Contains("reject") || s.Contains("fail") => Color.Error,
            var s when s.Contains("review") || s.Contains("pending") => Color.Warning,
            _ => Color.Default
        };
    }

    private void Close()
    {
        MudDialog.Close(DialogResult.Ok(true));
    }

    // Mock data for demonstration
    private CandidateHistoryDto GetMockData()
    {
        return new CandidateHistoryDto
        {
            ApplicationId = 12345,
            FirstName = "John",
            LastName = "Doe",
            CurrentStatus = "In Progress",
            Timeline = new List<TimelineItem>
            {
                new() {
                    Timestamp = DateTime.Now.AddDays(-15),
                    Status = "Application Submitted",
                    HRAssist = "Sarah Johnson",
                    Remarks = "Application received and under initial review."
                },
                new() {
                    Timestamp = DateTime.Now.AddDays(-12),
                    Status = "Under Review",
                    HRAssist = "Sarah Johnson",
                    Remarks = "Initial screening completed."
                },
                new() {
                    Timestamp = DateTime.Now.AddDays(-10),
                    Status = "Interview Scheduled",
                    HRAssist = "Michael Chen",
                    Remarks = "Phone screening scheduled for 14th March 2024 at 2:00 PM."
                },
                new() {
                    Timestamp = DateTime.Now.AddDays(-7),
                    Status = "Interview Completed",
                    HRAssist = "Michael Chen",
                    Remarks = "HR phone screening completed successfully."
                },
                new() {
                    Timestamp = DateTime.Now.AddDays(-3),
                    Status = "Technical Interview Scheduled",
                    HRAssist = "Emily Rodriguez",
                    Remarks = "Technical interview scheduled for 18th March 2024 at 10:00 AM."
                },
                new() {
                    Timestamp = DateTime.Now.AddDays(-1),
                    Status = "Technical Interview Completed",
                    HRAssist = "Emily Rodriguez",
                    Remarks = "Technical interview completed. Candidate performed well."
                }
            }
        };
    }

    // DTOs
    public class CandidateHistoryDto
    {
        public int ApplicationId { get; set; }
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string CurrentStatus { get; set; } = string.Empty;
        public List<TimelineItem> Timeline { get; set; } = new();
    }

    public class TimelineItem
    {
        public DateTime Timestamp { get; set; }
        public string Status { get; set; } = string.Empty;
        public string HRAssist { get; set; } = string.Empty;
        public string Remarks { get; set; } = string.Empty;
    }
}